# Share Buttons Implementation Guide for The Base App (TBA)

This document explains the differences found between working and failing share buttons in TBA mini-apps, and provides best practices for implementing social sharing functionality.

## Table of Contents
- [Problem Overview](#problem-overview)
- [Root Cause Analysis](#root-cause-analysis)
- [Working vs Failing Implementation](#working-vs-failing-implementation)
- [Solution](#solution)
- [Best Practices](#best-practices)
- [Testing Checklist](#testing-checklist)

---

## Problem Overview

When implementing share buttons using OnchainKit's `useComposeCast()` in a Farcaster mini-app, we encountered an issue where:
- ✅ **Button 1** (invitation): Worked perfectly in both Farcaster and TBA
- ❌ **Button 2** (results): Worked in Farcaster but failed in TBA with "mini app unavailable" error

### Deep Link Generated by TBA

```
cbwallet://compose?text=AHP+Result%3A+Opci%C3%B3n+A+78%25.+CR+0.0%25+%28OK%29.+Try+Saaty+AHP%3A&embeds%5B%5D=https%3A%2F%2Fdb-mini-app-quickstart.vercel.app&request_id=compose_1761928204073_jccfw3s6h
```

---

## Root Cause Analysis

### Initial Hypotheses (Incorrect)

1. ❌ **Query parameters in URL** - We thought `?s=base64...` was causing the issue
2. ❌ **URL length** - We suspected long URLs with encoded state
3. ❌ **Dynamic content in embeds** - We thought variable data was the problem
4. ❌ **Line breaks** - We removed `\n` characters

### Actual Root Cause (Correct)

✅ **Text complexity and special characters**

The Base App is more restrictive than Farcaster regarding the text content of shares. TBA rejects shares with:
- Nested quotes: `"${goal}"`
- Multiple special characters: `:`, `()`, `%` with decimals
- Complex formatting with multiple variables
- Certain Unicode characters (tildes: `ó`, `á`, etc.)

---

## Working vs Failing Implementation

### ❌ Failing Button Implementation

```javascript
const handleShareResults = async () => {
  const rankedOptions = weights
    .map((w, i) => ({ name: options[i], weight: w }))
    .sort((a, b) => b.weight - a.weight);

  const winner = rankedOptions[0];
  const crStatus = consistency.CR < 0.1 ? "✓ Consistent" : "⚠ Review needed";

  // PROBLEMATIC: Complex text with nested quotes, special chars, decimals
  const goalText = goal ? ` for "${goal.substring(0, 40)}..."` : '';
  const text = `My AHP decision${goalText}: ${winner.name} wins with ${(winner.weight * 100).toFixed(0)}% weight. CR: ${(consistency.CR * 100).toFixed(1)}% (${crStatus}). Try it:`;

  const shareLink = process.env.NEXT_PUBLIC_URL || window.location.origin;

  const result = await composeCastAsync({
    text: text,
    embeds: [shareLink]
  });
};
```

**Issues:**
- `"${goal}"` - Nested double quotes
- `:` - Multiple colons
- `()` - Parentheses
- `%` - Percentage symbols with decimals
- `✓`, `⚠` - Emoji/special unicode characters
- Long, complex interpolated string

**Example generated text:**
```
My AHP decision for "Choose framework": Opción A wins with 78% weight. CR: 5.3% (OK). Try it:
```

---

### ✅ Working Button Implementation

```javascript
const handleShareResults = async () => {
  const rankedOptions = weights
    .map((w, i) => ({ name: options[i], weight: w }))
    .sort((a, b) => b.weight - a.weight);

  const winner = rankedOptions[0];

  // SIMPLIFIED: Simple text, single variable, no special chars
  const text = `I just completed an AHP analysis and the winner is ${winner.name}! Try it yourself: `;

  const shareLink = process.env.NEXT_PUBLIC_URL || window.location.origin;

  const result = await composeCastAsync({
    text: text,
    embeds: [shareLink]
  });
};
```

**Characteristics:**
- Simple sentence structure
- Only basic punctuation: `.`, `!`, `:`
- Single variable interpolation: `${winner.name}`
- No nested quotes or complex formatting
- ASCII characters only (or basic UTF-8)

**Example generated text:**
```
I just completed an AHP analysis and the winner is React! Try it yourself:
```

---

## Solution

### Key Changes Made

| Aspect | Before (Failed) | After (Works) |
|--------|----------------|---------------|
| **Text format** | Complex with multiple variables | Simple with single variable |
| **Quotes** | Nested `"..."` | None |
| **Special chars** | `():,%` with decimals | Only `.!:` |
| **Emojis** | `✓⚠` | None |
| **Variables** | 4-5 interpolations | 1 interpolation |
| **Length** | 100-150+ chars | 70-90 chars |
| **Unicode** | Tildes (`ó`) in variable content | Basic ASCII preferred |

### Evolution of Solutions

#### Attempt 1: Remove query parameters
```javascript
// Changed from:
const shareLink = `${baseUrl}?s=${encodedState}`;
// To:
const shareLink = baseUrl;
```
**Result:** ❌ Still failed

#### Attempt 2: Remove line breaks
```javascript
// Changed from:
const text = `Line 1\nLine 2\nLine 3`;
// To:
const text = `Line 1. Line 2. Line 3.`;
```
**Result:** ❌ Still failed

#### Attempt 3: Simplify text to match working button
```javascript
// Changed from complex formatting to simple
const text = `I just completed an AHP analysis and the winner is ${winner.name}! Try it yourself: `;
```
**Result:** ✅ **SUCCESS!**

---

## Best Practices

### ✅ DO's for TBA Share Buttons

1. **Keep text simple and concise**
   ```javascript
   const text = `Simple message with ${oneVariable}! Call to action: `;
   ```

2. **Use basic punctuation only**
   - Allowed: `.` `,` `!` `?` `:`
   - Avoid: `()` `[]` `{}` `"` `'` `%` `$`

3. **Limit variable interpolations**
   - Ideal: 1-2 variables max
   - Each variable should be simple (name, number without formatting)

4. **Test with actual user data**
   - Include edge cases: names with special chars, tildes, etc.
   - Test with empty states (no goal, default options)

5. **Use clean base URLs**
   ```javascript
   const shareLink = process.env.NEXT_PUBLIC_URL || window.location.origin;
   // https://your-app.vercel.app (no query params, no fragments)
   ```

6. **Keep text under 100 characters when possible**

7. **Use ASCII characters or basic UTF-8**
   - Avoid: Emojis, special symbols, accented characters in hardcoded text
   - User-generated content (like option names) should work, but be cautious

### ❌ DON'Ts for TBA Share Buttons

1. **Avoid nested quotes**
   ```javascript
   // DON'T
   const text = `Result for "${goal}": Winner is ${name}`;
   // DO
   const text = `Result for ${goal}: Winner is ${name}`;
   ```

2. **Don't use complex formatting**
   ```javascript
   // DON'T
   const text = `Analysis:\n1. ${opt1} (${pct1}%)\n2. ${opt2} (${pct2}%)`;
   // DO
   const text = `Analysis winner: ${opt1}. Try it: `;
   ```

3. **Avoid multiple special characters**
   ```javascript
   // DON'T
   const text = `Result: ${name} (${pct}%) - CR: ${cr}% (${status})`;
   // DO
   const text = `Winner: ${name} with ${pct} percent`;
   ```

4. **Don't rely on query parameters for state**
   ```javascript
   // DON'T (for TBA validation)
   const shareLink = `${baseUrl}?data=${encoded}`;
   // DO
   const shareLink = baseUrl;
   ```

5. **Don't use emoji indicators**
   ```javascript
   // DON'T
   const status = cr < 0.1 ? "✓ OK" : "⚠ Review";
   // DO
   const status = cr < 0.1 ? "OK" : "Review";
   ```

---

## Implementation Template

### Basic Share Button (Always Works)

```javascript
import { useComposeCast } from '@coinbase/onchainkit/minikit';

export default function MyComponent() {
  const { composeCastAsync } = useComposeCast();

  const handleShare = async () => {
    try {
      const text = `Check out this amazing app! Try it yourself: `;

      const result = await composeCastAsync({
        text: text,
        embeds: [process.env.NEXT_PUBLIC_URL || window.location.origin]
      });

      if (result?.cast) {
        console.log("Cast created successfully:", result.cast.hash);
      } else {
        console.log("User cancelled the cast");
      }
    } catch (error) {
      console.error("Error sharing cast:", error);
    }
  };

  return <button onClick={handleShare}>Share</button>;
}
```

### Advanced Share with Dynamic Content (Safe Pattern)

```javascript
const handleShareResults = async () => {
  try {
    // Get your dynamic data
    const winner = getWinnerOption();

    // Keep text simple - one variable, basic punctuation
    const text = `I just completed an analysis and the winner is ${winner.name}! Try it yourself: `;

    // Clean URL
    const shareLink = process.env.NEXT_PUBLIC_URL || window.location.origin;

    // Debug logging (helpful for troubleshooting)
    console.log('Share text:', text);
    console.log('Share URL:', shareLink);

    const result = await composeCastAsync({
      text: text,
      embeds: [shareLink]
    });

    if (result?.cast) {
      console.log("Success:", result.cast.hash);
    }
  } catch (error) {
    console.error("Share error:", error);
  }
};
```

---

## Testing Checklist

When implementing share buttons for TBA mini-apps, test:

### Functional Tests
- [ ] Button 1 works in Farcaster
- [ ] Button 1 works in TBA
- [ ] Button 2 works in Farcaster
- [ ] Button 2 works in TBA
- [ ] Both buttons generate correct deep links

### Edge Cases
- [ ] Empty/default option names
- [ ] Option names with special characters (tildes, accents)
- [ ] Very long option names (40+ chars)
- [ ] Empty goal/title
- [ ] Decimal values (percentages, ratios)
- [ ] Special states (zero values, extreme values)

### TBA-Specific Validation
- [ ] Text length < 100 chars (ideal) or < 200 chars (max)
- [ ] No nested quotes in text
- [ ] No complex special characters (emoji, symbols)
- [ ] URL is exactly the registered mini-app URL
- [ ] No query parameters in embed URL (if possible)

### Debug Logging
```javascript
console.log('=== Share Debug ===');
console.log('Text length:', text.length);
console.log('Text:', text);
console.log('URL:', shareLink);
console.log('URL length:', shareLink.length);
```

---

## Comparison Table

| Feature | Farcaster | The Base App |
|---------|-----------|--------------|
| **Text complexity** | High tolerance | Low tolerance |
| **Special chars** | Most accepted | Limited set |
| **Emojis** | ✅ Accepted | ⚠️ May cause issues |
| **Nested quotes** | ✅ Works | ❌ Causes failure |
| **Line breaks** | ✅ Works | ⚠️ Avoid |
| **URL query params** | ✅ Works | ⚠️ May validate against base URL |
| **Max text length** | ~320 chars | ~200 chars (safe) |
| **Unicode support** | Full | Basic (be cautious) |

---

## Debugging Failed Shares

If your share button fails in TBA but works in Farcaster:

### Step 1: Simplify the text
```javascript
// Test with the most basic text possible
const text = `Test message. Try it: `;
```

### Step 2: Remove all special characters
```javascript
// Remove: quotes, parentheses, emojis, symbols
// Keep only: letters, numbers, basic punctuation (. ! ?)
```

### Step 3: Use exact base URL
```javascript
const shareLink = process.env.NEXT_PUBLIC_URL;
// Ensure this is EXACTLY the URL registered in TBA manifest
```

### Step 4: Check deep link in browser console
```javascript
// TBA generates cbwallet:// deep links
// Look for URL encoding issues: %22 (quotes), %3A (colon), etc.
```

### Step 5: Compare with working button
- Use the exact same text structure as a working button
- Add complexity gradually until it breaks
- Identify the breaking point

---

## Reference Implementation

This mini-app has two fully functional share buttons:

### Button 1: Invitation (Generic)
- **Location:** `app/page.tsx:120-137`
- **Text:** Static invitation message
- **Purpose:** Promote the app generally

### Button 2: Results (Personalized)
- **Location:** `app/page.tsx:139-175`
- **Text:** Dynamic with winner name
- **Purpose:** Share specific analysis result

**Both work in Farcaster and TBA!** ✅

---

## Additional Resources

- [OnchainKit Documentation](https://onchainkit.xyz/)
- [Farcaster Frames Spec](https://docs.farcaster.xyz/reference/frames/spec)
- [Base Mini Apps Guide](https://docs.base.org/mini-apps/)
- [Coinbase Wallet Deep Links](https://docs.cloud.coinbase.com/wallet-sdk/docs/deep-links)

---

## Version History

- **v1.0** (2025-01-31): Initial documentation
  - Identified text complexity as root cause
  - Documented working solution
  - Created best practices guide

---

## Questions or Issues?

If you encounter similar issues in future mini-apps:

1. Start with the simplest possible text
2. Use the patterns documented here
3. Test in both Farcaster and TBA
4. Add complexity gradually
5. Document what breaks it

**Key takeaway:** The Base App is more restrictive than Farcaster. When in doubt, keep it simple! 🎯
